<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Microphone capture example</title>
  </head>
  <body>
    <h1>Microphone capture example</h1>
    <button id="recordButton">Record</button>
    <button id="stopButton" disabled>Stop</button>
    <script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs/dist/recorder.js"></script>
    <script>
      var audioContext;
      var audioStream;
      var recorder;

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          audioStream = stream;
          audioContext = new AudioContext();
          var input = audioContext.createMediaStreamSource(stream);
          recorder = new Recorder(input);
        })
        .catch(function(err) {
          console.log('Error: ' + err);
        });

      function startRecording() {
        recorder && recorder.clear();
        recorder && recorder.record();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = false;
      }

      function stopRecording() {
        recorder && recorder.stop();
        document.getElementById("recordButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
        recorder && recorder.exportWAV(uploadAudio);
      }

      function uploadAudio(blob) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/audio', true);
        xhr.setRequestHeader('Content-Type', 'audio/wav');
        xhr.onload = function(e) {
          if (this.status == 200) {
            console.log('Audio uploaded successfully');
          }
        };
        xhr.send(blob);
      }

      document.getElementById("recordButton").addEventListener("click", startRecording);
      document.getElementById("stopButton").addEventListener("click", stopRecording);
    </script>
  </body>
</html>
