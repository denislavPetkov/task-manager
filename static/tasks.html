<!DOCTYPE html>
<html>
<head>
	<title>Tasks</title>
	<link rel="stylesheet" type="text/css" href="/static/css/styles.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
	<h1>Tasks</h1>
	<div>
		<button onclick="logout()">Logout</button>
		<button onclick="addNewTask()">Add New Task</button>
	</div>
	<div id="filter-container">
		<label for="category-filter">Category:</label>
		<input type="text" id="category-filter" placeholder="Filter by category...">
		<label for="tags-filter">Tags:</label>
		<input type="text" id="tags-filter" placeholder="Filter by tags...">
		<label for="done-filter">Done:</label>
		<select id="done-filter">
			<option value="all" selected>All</option>
			<option value="done">Done</option>
			<option value="not-done">Not Done</option>
		</select>
	</div>
	<div id="task-container">
		<table>
			<thead>
				<tr>
					<th>Done</th>
					<th>Title</th>
					<th>Deadline</th>
					<th>Description</th>
					<th>Category</th>
					<th>Tags</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<script>
					var tasks = JSON.parse("{{ .Tasks }}");
				
					for (var i = 0; i < tasks.length; i++) {
						var task = tasks[i];

						var tr = document.createElement("tr");
						tr.innerHTML = '<td><input type="checkbox" onclick="markAsDone(this, ' + i + ')" ' +
									(task.completed ? 'checked' : '') + '></td>' +
									"<td>" + task.title + "</td>" +
									"<td>" + new Date(task.deadline).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).replace(/ /g, '-') + "</td>" +
									"<td>" + task.description + "</td>" +
									"<td>" + task.category + "</td>" +
									"<td>" + (task.tags ? task.tags.join(", ") : "") + "</td>" +
									'<td><button onclick="editTask(\'' + task.title + '\')">Edit</button></td>' +
									'<td><button onclick="deleteTask(\'' + task.title + '\', ' + i + ')">Delete</button></td>';
						document.querySelector("table tbody").appendChild(tr);

						if (task.completed) {
							tr.classList.add("done");
						}
					}

					// Add event listeners to the filter input fields
					var categoryFilter = document.getElementById("category-filter");
					categoryFilter.addEventListener("input", filterTasks);
					
					var tagsFilter = document.getElementById("tags-filter");
					tagsFilter.addEventListener("input", filterTasks);

					var doneFilter = document.getElementById("done-filter");
					doneFilter.addEventListener("input", filterTasks);

					function logout() {
						window.location.href = "/logout";
					}
				
					function addNewTask() {
						window.location.href = window.location.href + "/new";
					}
					
					function markAsDone(checkbox, index) {
						var task = tasks[index];

						$.ajax({
        					url: window.location.href+ '/completed/' + task.title,
        					type: 'POST',
							headers: {
            					'X-CSRF-Token': "{{ .csrf }}"
        					},
							data: {
								completed: !task.completed
							},
        					success: function(result) {
								task.completed = result.completed;
								$("td:contains('" + task.title + "')").parent().toggleClass("done", result.completed);
							}
						});
					}

					function deleteTask(title,rowIndex) {
    					$.ajax({
        					url: window.location.href+ '/delete/' + title,
        					type: 'DELETE',
							headers: {
            					'X-CSRF-Token': "{{ .csrf }}"
        					},
        					success: function(result) {
								document.querySelector("table tbody").deleteRow(rowIndex);
							}
						});
					}

					function editTask(title) {
						var task = tasks.find(function(n) {
							return n.title === title;
						});
						localStorage.setItem(title, JSON.stringify(task));
						var url = window.location.href + '/edit/' + encodeURIComponent(title);
						window.location.href = url;
					}
					
					function filterTasks() {
						var category = categoryFilter.value.toLowerCase();
						var tags = tagsFilter.value.toLowerCase().split(",").map(tag => tag.trim());
						var done = doneFilter.value;

						var tasks = document.querySelectorAll("table tbody tr");
						for (var i = 0; i < tasks.length; i++) {
							var task = tasks[i];
							var categoryText = task.querySelector("td:nth-of-type(5)").textContent.toLowerCase();
							var tagsText = task.querySelector("td:nth-of-type(6)").textContent.toLowerCase();
							var doneValue = task.querySelector("td:nth-of-type(1) input").checked;

							var tagsMatch = true;
							for (var j = 0; j < tags.length; j++) {
								if (tags[j] !== "" && !tagsText.includes(tags[j])) {
									tagsMatch = false;
									break;
								}
							}

							var doneMatch = true;
							if (done === "done") {
							doneMatch = doneValue === true;
							} else if (done === "not-done") {
							doneMatch = doneValue === false;
							}

							if (categoryText.includes(category) && tagsMatch && doneMatch) {
								task.style.display = "";
							} else {
								task.style.display = "none";
							}
						}
					}
					
					function tagsMatch(text, tags) {
						for (var i = 0; i < tags.length; i++) {
							if (tags[i].trim() != "" && !text.includes(tags[i].trim())) {
								return false;
							}
						}
						return true;
					}
				</script>
			</tbody>
		</table>
	</div>
</body>
</html>
